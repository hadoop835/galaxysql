## DISABLE_FAST_SQL_PARSER
## RESERVE_SEMICOLONS

set TTL_DEBUG_CCI_SKIP_DDL_TASKS = "WaitColumnarTableAlterPartitionTask,WaitColumnarTableCreationTask";
set SKIP_DDL_TASKS="WaitColumnarTableAlterPartitionTask,WaitColumnarTableCreationTask";
set TTL_DEBUG_CURRENT_DATETIME='2025-01-08 00:00:00';
set TTL_FORBID_DROP_TTL_TBL_WITH_ARC_CCI=false;
set ENABLE_DROP_TRUNCATE_CCI_PARTITION=true;

create table auto_rng_part_tc8_t1(
a int not null auto_increment,
b bigint not null,
primary key(a)
)
PARTITION BY KEY(`a`)
PARTITIONS 2
SUBPARTITION BY RANGE COLUMNS(`b`)
(
SUBPARTITION `sp20250104` VALUES LESS THAN (1735920000000),
SUBPARTITION `sp20250105` VALUES LESS THAN (1736006400000),
SUBPARTITION `sp20250106` VALUES LESS THAN (1736092800000),
SUBPARTITION `sp20250107` VALUES LESS THAN (1736179200000)
);


alter table auto_rng_part_tc8_t1 modify ttl set ttl_expr= from_unixtime(`b`/ 1000) expire after 3 DAY timezone '+08:00',ttl_part_interval=interval(1,DAY),archive_type='SUBPARTITION', archive_table_post_allocate=2, archive_table_pre_allocate=5;

alter table auto_rng_part_tc8_t1 cleanup expired data;
create table auto_rng_part_tc8_t1_bk like auto_rng_part_tc8_t1 engine=columnar archive_mode='ttl';

set TTL_DEBUG_CURRENT_DATETIME='2025-01-09 00:00:00';
alter table auto_rng_part_tc8_t1 cleanup expired data;
show create table auto_rng_part_tc8_t1;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-10 00:00:00';
alter table auto_rng_part_tc8_t1 cleanup expired data;
show create table auto_rng_part_tc8_t1;

alter table auto_rng_part_tc8_t1 modify ttl set ttl_cleanup='on';

alter table auto_rng_part_tc8_t1 cleanup expired data;
show create table auto_rng_part_tc8_t1;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-11 00:00:00';
alter table auto_rng_part_tc8_t1 cleanup expired data;
show create table auto_rng_part_tc8_t1;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-12 00:00:00';
alter table auto_rng_part_tc8_t1 cleanup expired data;
show create table auto_rng_part_tc8_t1;

drop table auto_rng_part_tc8_t1;


create table auto_rng_part_tc8_t2(
a int not null auto_increment,
b bigint not null,
primary key(a)
)
PARTITION BY KEY(`a`)
PARTITIONS 2
SUBPARTITION BY RANGE COLUMNS(`b`)
(
SUBPARTITION `sp20250104` VALUES LESS THAN (1735920000),
SUBPARTITION `sp20250105` VALUES LESS THAN (1736006400),
SUBPARTITION `sp20250106` VALUES LESS THAN (1736092800),
SUBPARTITION `sp20250107` VALUES LESS THAN (1736179200)
);


alter table auto_rng_part_tc8_t2 modify ttl set ttl_expr= from_unixtime(`b`) expire after 3 DAY timezone '+08:00',ttl_part_interval=interval(1,DAY),archive_type='SUBPARTITION', archive_table_post_allocate=2, archive_table_pre_allocate=5;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-08 00:00:00';
alter table auto_rng_part_tc8_t2 cleanup expired data;

create table auto_rng_part_tc8_t2_bk like auto_rng_part_tc8_t2 engine=columnar archive_mode='ttl';

set TTL_DEBUG_CURRENT_DATETIME='2025-01-09 00:00:00';
alter table auto_rng_part_tc8_t2 cleanup expired data;
show create table auto_rng_part_tc8_t2;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-10 00:00:00';
alter table auto_rng_part_tc8_t2 cleanup expired data;
show create table auto_rng_part_tc8_t2;

alter table auto_rng_part_tc8_t2 modify ttl set ttl_cleanup='on';

alter table auto_rng_part_tc8_t2 cleanup expired data;
show create table auto_rng_part_tc8_t2;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-11 00:00:00';
alter table auto_rng_part_tc8_t2 cleanup expired data;
show create table auto_rng_part_tc8_t2;

set TTL_DEBUG_CURRENT_DATETIME='2025-01-12 00:00:00';
alter table auto_rng_part_tc8_t2 cleanup expired data;
show create table auto_rng_part_tc8_t2;

drop table auto_rng_part_tc8_t2;


