## DISABLE_FAST_SQL_PARSER
## RESERVE_SEMICOLONS

set TTL_DEBUG_USE_GSI_FOR_COLUMNAR_ARC_TBL = false;
set TTL_DEBUG_CCI_SKIP_DDL_TASKS = "WaitColumnarTableAlterPartitionTask,WaitColumnarTableCreationTask";
set SKIP_DDL_TASKS="WaitColumnarTableAlterPartitionTask,WaitColumnarTableCreationTask";
set TTL_DEBUG_CURRENT_DATETIME='2024-06-27 00:00:00';
set TTL_FORBID_DROP_TTL_TBL_WITH_ARC_CCI=false;

create table auto_rng_part_t1(
a int not null auto_increment,
b datetime default current_timestamp,
primary key(a)
)
ttl = ttl_definition( 
  TTL_EXPR = `b` EXPIRE AFTER 2 DAY TIMEZONE '+08:00',
  ARCHIVE_TYPE = 'PARTITION',
  ARCHIVE_TABLE_PRE_ALLOCATE = 2,
  ARCHIVE_TABLE_POST_ALLOCATE = 2 )
partition by range columns(b) 
(
  partition p1 values less than('2021-02-01'),
  partition p2 values less than('2021-02-02'),
  partition p3 values less than('2021-02-03')
)
;
alter table auto_rng_part_t1 cleanup expired data;

set TTL_DEBUG_CURRENT_DATETIME='2024-07-27 00:00:00';
alter table auto_rng_part_t1 cleanup expired data;

set TTL_DEBUG_CURRENT_DATETIME='2024-06-27 00:00:00';
create table auto_rng_part_t2(
a int not null auto_increment,
b datetime default current_timestamp,
primary key(a)
)
ttl = ttl_definition(
TTL_EXPR = `b` EXPIRE AFTER 2 DAY TIMEZONE '+08:00',
ARCHIVE_TYPE = 'PARTITION',
ARCHIVE_TABLE_PRE_ALLOCATE = 2,
ARCHIVE_TABLE_POST_ALLOCATE = 2 )
partition by range columns(b)
(
partition p1 values less than('2021-02-01'),
partition p2 values less than('2021-02-02'),
partition p3 values less than('2021-02-03'),
partition pmax values less than(maxvalue)
)
;

alter table auto_rng_part_t2 cleanup expired data;

set TTL_DEBUG_CURRENT_DATETIME='2024-06-28 00:00:00';
alter table auto_rng_part_t2 cleanup expired data;

set TTL_DEBUG_CURRENT_DATETIME='2024-06-29 00:00:00';
alter table auto_rng_part_t2 cleanup expired data;

create table auto_rng_part_t2_bk like auto_rng_part_t2 engine='columnar' archive_mode='ttl';

create table auto_rng_part_t3(
a int not null auto_increment,
b datetime default current_timestamp,
primary key(a)
)
ttl = ttl_definition(
TTL_EXPR = `b` EXPIRE AFTER 2 DAY TIMEZONE '+08:00',
ARCHIVE_TYPE = 'PARTITION',
ARCHIVE_TABLE_PRE_ALLOCATE = 2,
ARCHIVE_TABLE_POST_ALLOCATE = 2 )
partition by range (to_days(b))
(
partition p1 values less than(to_days('2021-02-01')),
partition p2 values less than(to_days('2021-02-02')),
partition p3 values less than(to_days('2021-02-03'))
)
;

create table auto_rng_part_t4(
a int not null auto_increment,
b timestamp default current_timestamp,
primary key(a)
)
ttl = ttl_definition(
TTL_EXPR = `b` EXPIRE AFTER 2 DAY TIMEZONE '+08:00',
ARCHIVE_TYPE = 'PARTITION',
ARCHIVE_TABLE_PRE_ALLOCATE = 2,
ARCHIVE_TABLE_POST_ALLOCATE = 2 )
partition by range (unix_timestamp(b))
(
partition p1 values less than(unix_timestamp('2021-02-01')),
partition p2 values less than(unix_timestamp('2021-02-02')),
partition p3 values less than(unix_timestamp('2021-02-03'))
)
;

alter table auto_rng_part_t4 cleanup expired data;
create table auto_rng_part_t4_bk like auto_rng_part_t4 engine='columnar' archive_mode='ttl';

set TTL_DEBUG_CURRENT_DATETIME='2024-06-28 00:00:00';
alter table auto_rng_part_t4 cleanup expired data;

create table auto_rng_part_t5(
a int not null auto_increment,
b datetime default null,
primary key(a)
)
ttl = ttl_definition(
TTL_EXPR = `b` EXPIRE AFTER 2 DAY TIMEZONE '+08:00',
ARCHIVE_TYPE = 'PARTITION',
ARCHIVE_TABLE_PRE_ALLOCATE = 2,
ARCHIVE_TABLE_POST_ALLOCATE = 2 )
partition by range (to_days(b))
(
partition p1 values less than(to_days('2021-02-01')),
partition p2 values less than(to_days('2021-02-02')),
partition p3 values less than(to_days('2021-02-03'))
)
;


create table auto_rng_part_t5_bk like auto_rng_part_t5 engine='columnar' archive_mode='ttl';
alter table auto_rng_part_t5 cleanup expired data;



drop table auto_rng_part_t1;
drop table auto_rng_part_t2;
drop table auto_rng_part_t3;
drop table auto_rng_part_t4;
drop table auto_rng_part_t5;




